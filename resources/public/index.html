<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Aggregator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.15/dist/scittle.js" type="application/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.15/dist/scittle.reagent.js" type="application/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.15/dist/scittle.re-frame.js" type="application/javascript"></script>
    <script src="js/categories.cljs" type="application/x-scittle"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #0051d5;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .transaction-amount {
            font-family: 'Monaco', 'Courier New', monospace;
        }
        .positive { color: #2e7d32; }
        .negative { color: #d32f2f; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="application/x-scittle">
    (ns finance-aggregator.ui
      (:require [reagent.core :as r]
                [reagent.dom :as rdom]
                [re-frame.core :as rf]
                [finance-aggregator.ui.categories :as categories]))

    ;; Event handlers
    (rf/reg-event-db
      ::initialize
      (fn [_ _]
        {:stats nil
         :accounts []
         :transactions []
         :institutions []
         :categories []
         :category-form {:show? false :editing-id nil :name "" :type :expense}
         :loading #{}}))

    (rf/reg-event-db
      ::set-loading
      (fn [db [_ key loading?]]
        (if loading?
          (update db :loading conj key)
          (update db :loading disj key))))

    (rf/reg-event-db
      ::set-stats
      (fn [db [_ stats]]
        (assoc db :stats stats)))

    (rf/reg-event-db
      ::set-accounts
      (fn [db [_ accounts]]
        (assoc db :accounts accounts)))

    (rf/reg-event-db
      ::set-transactions
      (fn [db [_ transactions]]
        (assoc db :transactions transactions)))

    (rf/reg-event-db
      ::set-institutions
      (fn [db [_ institutions]]
        (assoc db :institutions institutions)))

    (rf/reg-event-db
      ::set-error
      (fn [db [_ error]]
        (assoc db :error error)))

    ;; Make set-loading and set-error available globally
    (rf/reg-event-db
      :finance-aggregator.ui/set-loading
      (fn [db [_ key loading?]]
        (if loading?
          (update db :loading conj key)
          (update db :loading disj key))))

    (rf/reg-event-db
      :finance-aggregator.ui/set-error
      (fn [db [_ error]]
        (assoc db :error error)))

    ;; Subscriptions
    (rf/reg-sub
      ::stats
      (fn [db _]
        (:stats db)))

    (rf/reg-sub
      ::accounts
      (fn [db _]
        (:accounts db)))

    (rf/reg-sub
      ::transactions
      (fn [db _]
        (:transactions db)))

    (rf/reg-sub
      ::institutions
      (fn [db _]
        (:institutions db)))

    (rf/reg-sub
      ::loading?
      (fn [db [_ key]]
        (contains? (:loading db) key)))

    (rf/reg-sub
      :finance-aggregator.ui/loading?
      (fn [db [_ key]]
        (contains? (:loading db) key)))

    (rf/reg-sub
      ::error
      (fn [db _]
        (:error db)))

    ;; API calls
    (defn fetch-json [url on-success on-error]
      (-> (js/fetch url)
          (.then (fn [response]
                   (if (.-ok response)
                     (.json response)
                     (throw (js/Error. (str "HTTP error: " (.-status response)))))))
          (.then (fn [js-data]
                   ;; Convert JavaScript object to ClojureScript data structures
                   (let [clj-data (js->clj js-data :keywordize-keys true)]
                     (on-success clj-data))))
          (.catch on-error)))

    (rf/reg-event-fx
      ::fetch-stats
      (fn [_ _]
        {:dispatch [::set-loading :stats true]}
        (fetch-json
          "/api/stats"
          (fn [data]
            (rf/dispatch [::set-loading :stats false])
            (if (:success data)
              (rf/dispatch [::set-stats (:data data)])
              (rf/dispatch [::set-error (:error data)])))
          (fn [error]
            (rf/dispatch [::set-loading :stats false])
            (rf/dispatch [::set-error (str error)])))
        {}))

    (rf/reg-event-fx
      ::fetch-accounts
      (fn [_ _]
        {:dispatch [::set-loading :accounts true]}
        (fetch-json
          "/api/accounts"
          (fn [data]
            (rf/dispatch [::set-loading :accounts false])
            (if (:success data)
              (rf/dispatch [::set-accounts (:data data)])
              (rf/dispatch [::set-error (:error data)])))
          (fn [error]
            (rf/dispatch [::set-loading :accounts false])
            (rf/dispatch [::set-error (str error)])))
        {}))

    (rf/reg-event-fx
      ::fetch-transactions
      (fn [_ _]
        {:dispatch [::set-loading :transactions true]}
        (fetch-json
          "/api/transactions"
          (fn [data]
            (rf/dispatch [::set-loading :transactions false])
            (if (:success data)
              (rf/dispatch [::set-transactions (:data data)])
              (rf/dispatch [::set-error (:error data)])))
          (fn [error]
            (rf/dispatch [::set-loading :transactions false])
            (rf/dispatch [::set-error (str error)])))
        {}))

    (rf/reg-event-fx
      ::fetch-institutions
      (fn [_ _]
        {:dispatch [::set-loading :institutions true]}
        (fetch-json
          "/api/institutions"
          (fn [data]
            (rf/dispatch [::set-loading :institutions false])
            (if (:success data)
              (rf/dispatch [::set-institutions (:data data)])
              (rf/dispatch [::set-error (:error data)])))
          (fn [error]
            (rf/dispatch [::set-loading :institutions false])
            (rf/dispatch [::set-error (str error)])))
        {}))

    ;; Components
    (defn stats-card [label value loading?]
      [:div.stat-card
       [:h3 label]
       [:div.number
        (if loading?
          "..."
          (or value "0"))]])

    (defn stats-section []
      (let [stats @(rf/subscribe [::stats])
            loading? @(rf/subscribe [::loading? :stats])]
        [:div
         [:h1 "Finance Aggregator"]
         [:button {:on-click #(rf/dispatch [::fetch-stats])}
          "Refresh Stats"]
         [:div.stats
          [stats-card "Institutions" (:institutions stats) loading?]
          [stats-card "Accounts" (:accounts stats) loading?]
          [stats-card "Transactions" (:transactions stats) loading?]]]))

    (defn accounts-section []
      (let [accounts @(rf/subscribe [::accounts])
            loading? @(rf/subscribe [::loading? :accounts])]
        [:div.section
         [:h2 "Accounts"]
         [:button {:on-click #(rf/dispatch [::fetch-accounts])}
          "Load Accounts"]
         (cond
           loading?
           [:div.loading "Loading accounts..."]

           (empty? accounts)
           [:p "No accounts loaded. Click 'Load Accounts' to fetch data."]

           :else
           [:table
            [:thead
             [:tr
              [:th "Name"]
              [:th "Type"]
              [:th "Currency"]
              [:th "External ID"]]]
            [:tbody
             (for [account accounts]
               ^{:key (:db/id account)}
               [:tr
                [:td (:account/external-name account "N/A")]
                [:td (:account/type account "N/A")]
                [:td (:account/currency account "N/A")]
                [:td [:code (:account/external-id account "N/A")]]])]])]))

    (defn format-amount [amount]
      (when amount
        (.toFixed (js/Number. amount) 2)))

    (defn transactions-section []
      (let [transactions @(rf/subscribe [::transactions])
            loading? @(rf/subscribe [::loading? :transactions])]
        [:div.section
         [:h2 "Recent Transactions"]
         [:button {:on-click #(rf/dispatch [::fetch-transactions])}
          "Load Transactions"]
         (cond
           loading?
           [:div.loading "Loading transactions..."]

           (empty? transactions)
           [:p "No transactions loaded. Click 'Load Transactions' to fetch data."]

           :else
           [:table
            [:thead
             [:tr
              [:th "Date"]
              [:th "Payee"]
              [:th "Description"]
              [:th "Amount"]]]
            [:tbody
             (for [tx (take 20 transactions)]
               ^{:key (:db/id tx)}
               [:tr
                [:td (when-let [date (:transaction/posted-date tx)]
                       (.toLocaleDateString (js/Date. date)))]
                [:td (:transaction/payee tx "N/A")]
                [:td (:transaction/description tx "")]
                [:td.transaction-amount
                 {:class (if (pos? (or (:transaction/amount tx) 0))
                          "positive"
                          "negative")}
                 (str "$" (format-amount (:transaction/amount tx)))]])]])]))

    (defn error-display []
      (when-let [error @(rf/subscribe [::error])]
        [:div.error
         [:strong "Error: "] error
         [:button {:on-click #(rf/dispatch [::set-error nil])
                   :style {:margin-left "10px"}}
          "Dismiss"]]))

    (defn app []
      [:div
       [error-display]
       [stats-section]
       [categories/category-list]
       [accounts-section]
       [transactions-section]])

    ;; Initialize
    (defn ^:export init []
      (rf/dispatch-sync [::initialize])
      (rdom/render [app] (.getElementById js/document "app"))
      ;; Auto-load stats on init
      (rf/dispatch [::fetch-stats]))

    ;; Start the app
    (init)
    </script>
</body>
</html>
